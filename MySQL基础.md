# 对于InnoDB引擎，MySQL的一行是怎么存储的
创建一个数据库的时候，会在 `/var/lib/mysql/` 目录下创建一个和数据库同名的目录，将所有的表结构和表数据存放在这个目录里面

数据库目录里面存放的文件：
* db.opt, 用来存放当前字符集和字符校验规则。
* 对于每个表都有两个对应的文件 `表名.frm` 和 `表名.ibd` 。前者用于存储表的结构，主要包含表的结构定义， 后者用于存储对应的表数据。

注：表数据既可以存放在共享表空间文件，也可以存放在独占表空间文件。这个行为受到参数 `innodb_file_per_tabl` 的控制。

表空间的文件结构：

InnoDB引擎的存储结构：文件由若干段组成，段由若干区组成，区由若干页组成，页由若干行组成。

* 行：数据库的记录都是按行存放的，不同的行格式有不同的存储结构。
* 页：页是数据库读取的最小单位。读取的时候按页从磁盘读进内存，页是InnoDB最小的操作单位，一次最少读取一个页面进入内存，最少刷新一个页面回到磁盘。
* 区：大小为1MB，连续的64个页面会被划分为一个区，使用区的目的是为了在B+Tree中相邻节点的物理位置也相邻，减少随机I/O的次数。
* 段：由多个区组成，分为数据段、索引段、回滚段。

**InnoDB引擎的Compact行格式**：

`变长字段长度列表 + NULL值列表 + 记录头信息 + row_id + trx_id + roll_ptr + 列值1 + 列值2 + ··· + 列值n`

其中前3个是 "记录的额外信息" + 后面是 "记录的真实数据";

* 变长字段长度列表：存放变长字段所占的物理空间大小，求出该可变字段实际占用的大小空间，记录在变长字段长度列表中。<br>
记录规则：一个字节有8个bits，当最高位为0的时候表示该可变字段长度的大小占一个字节，当最高位为1的时候说明需要用两个字节的大小来表示该可变字段的长度。且每个可变字段的记录方式是逆序记录<br>
读取规则：逆序读取，如果发现当前读取字节的最高位为1，说明需要与下一个字节进行组合。如，一个变长字段占用的大小为6个字节，则在 `变长字段长度列表` 中记录为 `0x06`; 如果一个变长字段占用的大小为270个字节，则在 `变长字段长度列表中` 记录为 `0x0e81` ，读取0x81发现最高位是1，将最高位变为0后再读取下一个字节0x0e，将两个字节进行组合 `0x10e`表示变长字段占270字节。<br>
如果表中不存在变长字段的话，则不需要变长字段长度列表；


* NULL值列表：只有表可以位NULL的字段才能出现在NULL值列表中。一个字段占用1个bit，一个字节的二进制位表示8个bit，如果不足8个bit则再前面补0，如果表中有9个字段则NULL值列表占用2个字节，综上NULL值列表占用的字节数：表中每个字段对应每个二进制位，字节数向上取整。<br>
记录规则：如果对应的二进制位为空则再NULL值列表中对应的二进制位置1。<br>
当表中的每个字段都用NOT NULL约束的话，就不需要NULL值列表了。

* 记录头信息重要的信息：**delete_mask**是标识此条记录是否被删除、**next_record**下条记录的位置，指向下条记录的"记录头信息"和"真实数据"之间的位置、**record_type**表示当前记录的类型：0是普通记录，1是B+树叶子节点记录，2表示最小记录、3表示最大记录

* row_id, 如果没有主键以及唯一约束的话就需要隐藏字段，否则不需要隐藏字段
* trx_id, 事务id, 表示当前记录时由哪个事务生成的。
* roll_ptr, 此条记录上个版本的指针。

**行溢出后，MySQL的处理**
以Compact格式的行记录在溢出后，数据真实记录的地方保存一部分记录，剩下一部分数据用溢出页存储，溢出页的地址在真实数据处用20字节存储。

Compressed 和 Dynamic 这两个行格式和 Compact 非常类似，主要的区别在于处理行溢出数据时有些区别。这两种格式发生行溢出之后不会存储一部分列的数据，而是在真实数据处存放一个20自己大小的地址用于指向溢出页，真实数据存放在溢出页中